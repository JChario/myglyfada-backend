# myGlyfada Backend - Render.com Deployment

This directory contains the production-ready backend configured for deployment on Render.com with PostgreSQL.

## Quick Start

1. **Read the deployment guide:**
   - See [RENDER_SETUP.md](./RENDER_SETUP.md) for complete step-by-step instructions

2. **Key differences from development version:**
   - ✅ Uses PostgreSQL instead of SQLite
   - ✅ Schema uses proper PostgreSQL enums for UserRole, IssueStatus, IssuePriority
   - ✅ Configured for Render.com environment
   - ✅ Includes health check endpoint
   - ✅ Production-ready security settings

## Files Overview

```
render-backend/
├── src/                    # Application source code
├── prisma/
│   ├── schema.prisma      # PostgreSQL schema (with enums)
│   └── seed.ts            # Database seeding script
├── package.json           # Dependencies and scripts
├── tsconfig.json          # TypeScript configuration
├── render.yaml            # Render.com configuration (optional)
├── .env.production.template  # Environment variables template
├── .gitignore             # Git ignore rules
├── RENDER_SETUP.md        # Deployment instructions
└── README.md              # This file
```

## Environment Variables

Required environment variables for production:

| Variable | Description | Example |
|----------|-------------|---------|
| `DATABASE_URL` | PostgreSQL connection string | `postgresql://user:pass@host/db` |
| `JWT_SECRET` | Secret key for JWT tokens | Auto-generated by Render |
| `JWT_EXPIRES_IN` | Token expiration time | `7d` |
| `NODE_ENV` | Environment | `production` |
| `PORT` | Server port | `10000` |
| `ALLOWED_ORIGINS` | CORS allowed origins | `https://yourdomain.com` |
| `MAX_FILE_SIZE` | Max upload size in bytes | `5242880` (5MB) |
| `UPLOAD_PATH` | Upload directory | `./uploads` |

See `.env.production.template` for complete list.

## Build Commands

```bash
# Install dependencies
npm install

# Generate Prisma Client
npx prisma generate

# Build TypeScript
npm run build
```

## Start Commands

```bash
# Run migrations (production)
npx prisma migrate deploy

# Start server
npm start
```

## Database Migrations

### Create a new migration:
```bash
# Locally
npx prisma migrate dev --name migration_name

# This creates files in prisma/migrations/
# Commit these files to git
```

### Deploy migrations (production):
```bash
# Automatically runs on Render during deployment
npx prisma migrate deploy
```

### Seed the database:
```bash
npm run db:seed
```

## Key Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/health` | GET | Health check |
| `/api/auth/login` | POST | User login |
| `/api/auth/register` | POST | User registration |
| `/api/issues` | GET/POST | List/create issues |
| `/api/categories` | GET | List categories |

Full API documentation in the main project README.

## Database Schema Changes

When updating the schema:

1. **Edit `prisma/schema.prisma`**
2. **Create migration locally:**
   ```bash
   npx prisma migrate dev --name your_change
   ```
3. **Test locally**
4. **Commit migration files:**
   ```bash
   git add prisma/migrations/
   git commit -m "Add migration: your_change"
   ```
5. **Push to GitHub:**
   ```bash
   git push
   ```
6. **Render auto-deploys** and runs migrations

## PostgreSQL Enums

This schema uses PostgreSQL enums for type safety:

```typescript
enum UserRole {
  ADMIN
  SUPERVISOR
  USER
  OFFICE
}

enum IssueStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
  CANCELLED
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  EMERGENCY
}
```

## Differences from Development

| Feature | Development (SQLite) | Production (PostgreSQL) |
|---------|---------------------|-------------------------|
| Database | SQLite file | PostgreSQL server |
| Enums | String with validation | Native enum types |
| Performance | Limited | High performance |
| Concurrent users | Limited | Unlimited |
| Data size | Limited by disk | 1GB (free tier) |
| Backups | Manual | Automatic (paid tier) |

## Deployment Checklist

Before deploying:

- [ ] Environment variables configured
- [ ] Database created on Render
- [ ] CORS origins set correctly
- [ ] JWT secret generated
- [ ] Persistent disk added for uploads
- [ ] Health check endpoint working
- [ ] Migrations tested locally
- [ ] Seed data script verified

## Monitoring

### Logs
```bash
# View logs in Render dashboard
# Or use Render CLI:
render logs -s your-service-name
```

### Database
```bash
# Connect to database
# Use connection string from Render dashboard
psql <DATABASE_URL>
```

### Metrics
- CPU usage
- Memory usage
- Request rate
- Response time
- Error rate

All available in Render dashboard.

## Troubleshooting

### "Cannot find module @prisma/client"
```bash
# Make sure build command includes:
npx prisma generate
```

### "Migration failed"
```bash
# Reset database (WARNING: deletes all data)
npx prisma migrate reset --force
npx prisma migrate deploy
npm run db:seed
```

### "CORS error"
```bash
# Update ALLOWED_ORIGINS environment variable
# Include: https://yourdomain.com,https://www.yourdomain.com
```

## Support

- Render Docs: https://render.com/docs
- Prisma Docs: https://www.prisma.io/docs
- Express Docs: https://expressjs.com/

## License

MIT
